<template>
  <whppt-card>
    <whppt-table :items="roles" :headers="headers" hide-footer dense>
      <template v-slot:item.level.viewer="{ item }">
        <whppt-checkbox v-model="item.level.viewer" @change="updatePageRoles" />
      </template>
      <template v-slot:item.level.editor="{ item }">
        <whppt-checkbox v-model="item.level.editor" @change="updatePageRoles" />
      </template>
      <template v-slot:item.level.publisher="{ item }">
        <whppt-checkbox v-model="item.level.publisher" @change="updatePageRoles" />
      </template>
      <template v-slot:no-data>
        <div>{{ error }}</div>
      </template>
    </whppt-table>
  </whppt-card>
</template>

<script>
import { map } from 'lodash';
import { mapActions } from 'vuex';
import WhpptCard from '../../../ui/components/Card.vue';
import WhpptTable from '../../../ui/components/Table.vue';
import WhpptCheckbox from '../../../ui/components/Checkbox.vue';

export default {
  name: 'RolesPageSetting',
  components: { WhpptCard, WhpptTable, WhpptCheckbox },
  props: {
    page: {
      type: Object,
      default: () => ({}),
    },
  },
  data: () => ({
    roles: [],
    total: 0,
    error: '',
  }),
  computed: {
    headers() {
      return [
        { text: 'Name', align: 'start', value: 'name' },
        { text: 'Required For Viewing', align: 'start', value: 'level.viewer' },
        { text: 'Required For Editing', align: 'start', value: 'level.editor' },
        { text: 'Required For Publishing', align: 'start', value: 'level.publisher' },
      ];
    },
  },
  mounted() {
    this.loadRoles();
  },
  methods: {
    ...mapActions('whppt/page', ['applyRoles']),
    updatePageRoles() {
      this.applyRoles({ page: this.page, roles: this.roles });
    },
    loadRoles() {
      return this.$axios
        .$get(`${this.$whppt.apiPrefix}/roles/list`)
        .then(({ roles, total }) => {
          this.total = total;
          this.roles = map(roles, r => {
            const pageHasViewerRole = (this.page.viewerRoles && this.page.viewerRoles.includes(r._id)) || false;
            const pageHasEditorRole = (this.page.editorRoles && this.page.editorRoles.includes(r._id)) || false;
            const pageHasPublisherRole =
              (this.page.publisherRoles && this.page.publisherRoles.includes(r._id)) || false;

            return {
              ...r,
              level: { viewer: pageHasViewerRole, editor: pageHasEditorRole, publisher: pageHasPublisherRole },
            };
          });

          if (this.roles.length < 1) this.error = 'No Results found';
        })
        .catch(err => {
          if (err.response.status === 401) this.error = 'Missing Permissions';
        });
    },
  },
};
</script>

<style scoped></style>
